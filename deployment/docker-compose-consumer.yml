version: '3.8'

services:
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    networks:
      - consumer-network

  stream-processor:
    build: ../backend
    env_file:
      - consumer.env
    environment:
      - KAFKA_BROKER=${PRODUCER_IP}
      - REDIS_HOST=redis
      - HOST_IP=${HOST_IP}
    ports:
      - "8001:8001"  # Health check port
    command: >
      sh -c "cd /app && 
             python -c 'from src.stream_processor.processor import StreamProcessor; processor = StreamProcessor(); processor.process_stream()'"
    networks:
      - consumer-network

  ml-optimizer:
    build: ../backend
    env_file:
      - consumer.env
    environment:
      - KAFKA_BROKER=${PRODUCER_IP}
      - REDIS_HOST=redis
    command: >
      sh -c "cd /app && 
             python -c 'from src.ml_models.optimizer import EnergyOptimizer; optimizer = EnergyOptimizer(); optimizer.start_optimization()'"
    networks:
      - consumer-network

  backend-api:
    build: ../backend
    ports:
      - "8000:8000"
    env_file:
      - consumer.env
    environment:
      - REDIS_HOST=redis
      - KAFKA_BROKER=${PRODUCER_IP}
      - HOST_IP=${HOST_IP}
    depends_on:
      - redis
    command: >
      sh -c "cd /app && 
             python -m src.api.main"
    networks:
      - consumer-network

  frontend:
    build: ../frontend
    ports:
      - "3000:3000"
    env_file:
      - consumer.env
    environment:
      - VITE_API_URL=http://${HOST_IP}:8000
    depends_on:
      - backend-api
    networks:
      - consumer-network

networks:
  consumer-network:
    driver: bridge